---
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import { getRestaurante } from '@/Services/restauranteService.ts'; // 拘勇 Importa tu servicio
import Location from '@/assets/svg/map-pin.svg';
import Food from '@/assets/svg/tools-kitchen-3.svg';
import Phone from '@/assets/svg/phone.svg';
import Whatsapp from '@/assets/svg/brand-whatsapp.svg';
import Clock from '@/assets/svg/clock.svg';
import { Image } from 'astro:assets';
import ShareButton from '@/React/Buttons/ShareButton';
import MenuSectionWrapper from '@/React/MenuSectionWrapper';
import type { Horario } from '@/Types/Restaurante';
const API_URL = "http://localhost:5147";
// Importa todos los SVGs de amenidades
const svgModules = import.meta.glob(
  "/src/assets/amenidades/*.svg",
  { eager: true, import: "default" },
);

// Crea un mapa de SVGs
const amenidadesMap = Object.fromEntries(
  Object.entries(svgModules).map(([path, mod]) => {
    const filename = path.split("/").pop();
    return [filename, mod];
  }),
);

// 游늷 Obtenemos el id de la URL
const { id } = Astro.params;

// 游니 Carga din치mica del restaurante desde la API
let restaurant = null;
try {
  if (typeof id === "string") {
    restaurant = await getRestaurante(id);
  } else {
    console.warn("Par치metro 'id' ausente o no es una cadena:", id);
  }
} catch (error) {
  console.error("Error al cargar restaurante:", error);
}
// Control si puede tomar pedidos seg칰n plan
let tomarPedido = false;
if (restaurant?.planRestauranteId === 2 || restaurant?.plan?.nombre === "Est치ndar" || restaurant?.plan?.nombre === "Premium") {
  tomarPedido = true;
}

const description = `Perfil y men칰 de ${restaurant?.name ?? "Restaurante"}`;
---

<Layout title={`Mva Foods - ${restaurant?.name ?? "Restaurante"}`} description={description}>
  {
    restaurant ? (
      <div class="flex flex-col md:flex-row md:gap-[2%] flex-wrap content-start min-h-screen pt-24 pb-10 px-4 lg:px-24 bg-gradient-to-r from-orange-100 to-orange-50">
        <!-- Card lateral -->
        <div class="w-full md:w-1/4 bg-white shadow-lg rounded-lg text-center feature-step p-6">
          <Image
            src={typeof restaurant.image === "string" ? `${API_URL}${restaurant.image}` : "/images/placeholder.png"}
            alt={restaurant.name ?? "Restaurante"}
            title={restaurant.name}
            width="200"
            height="200"
            class="inline-block w-22 transition-transform group-hover:scale-110"
            style={{ "viewTransitionName": restaurant.id }}
          />

          <h2 class="text-2xl md:text-4xl font-semibold text-balance text-orange-600 mt-4">
            {restaurant.name}
          </h2>

          <ShareButton title={restaurant.name} client:only="react" />

          <div class="text-start flex flex-col gap-4 mt-4">
            <!-- Tipos -->
            <div class="flex items-start">
              <Food class="text-orange-600 w-5 h-5 mr-2" />
              <h2 class="text-md font-semibold text-orange-600">
                {restaurant.categorias?.map((c: { nombre: string }) => c.nombre).join(", ") ?? "Sin categor칤a"}
              </h2>
            </div>

            <!-- Direcci칩n -->
            <div class="flex items-start">
              <Location class="text-orange-600 w-5 h-5 mr-2" />
              <h2 class="text-md font-semibold text-orange-600">
                {restaurant.direccion}
              </h2>
            </div>

            <!-- Tel칠fono -->
            <div class="flex items-start">
              <Phone class="text-orange-600 w-5 h-5 mr-2" />
              <h2 class="text-md font-semibold text-orange-600">
                {restaurant.phone}
              </h2>
            </div>

            <!-- WhatsApp -->
            <div class="flex items-start">
              <Whatsapp class="text-orange-600 w-5 h-5 mr-2" />
              <h2 class="text-md font-semibold text-orange-600">
                {restaurant.phone}
              </h2>
            </div>

            <!-- Horarios -->
            <div class="flex">
              <Clock class="text-orange-600 w-5 h-5 mr-2 mt-1" />
              <div class="flex flex-col">
                {
                  restaurant?.horarios?.map((horario: Horario) => (
                    <div class="grid grid-cols-2 justify-between lg:gap-4 text-md font-semibold text-orange-600">
                      <p>{horario.diaTexto}:</p>
                      <p>{horario.horaAperturaTexto} a {horario.horaCierreTexto}</p>
                    </div>
                  ))
                }
              </div>
            </div>

            <!-- Amenidades -->
            <div class="flex items-start flex-wrap gap-2">
              {
                restaurant?.amenities?.map((amenidad: any) => {
                  const SvgIcon = amenidadesMap[amenidad.svg];
                  return (
                    <div class="flex flex-col items-center w-20 text-center group">
                      {SvgIcon && (
                        <SvgIcon class="w-10 h-10 mb-1 text-orange-600 fill-current transition-transform duration-200 group-hover:scale-110" />
                      )}
                      <h2 class="text-sm font-semibold text-orange-600">
                        {amenidad.nombre}
                      </h2>
                    </div>
                  );
                })
              }
            </div>

            <!-- Mapa -->
            <div class="relative w-full h-80 overflow-hidden rounded-lg">
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d28458.6750399274!2d-101.44747150906393!3d26.924612!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x868bcdc372021f57%3A0x1f92eebe5a1ab44a!2sBurger%20King!5e0!3m2!1ses!2smx!4v1749876497694!5m2!1ses!2smx"
                class="absolute top-0 left-0 w-full h-full border-0 lg:h-96"
                allowfullscreen
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade">
              </iframe>
            </div>
          </div>
        </div>

        <!-- Contenido central -->
        <div class="w-full md:flex-1 bg-white shadow-lg rounded-lg text-center feature-step p-6 mt-6 md:mt-0">
          <MenuSectionWrapper
            tomaPedido={tomarPedido}
            menu={restaurant?.menu ?? []}
            titulo="Men칰"
            client:load
          />
        </div>
      </div>
    ) : (
      <div class="p-10 text-center text-red-600 text-xl md:text-2xl">
        Restaurante no encontrado.
      </div>
    )
  }
</Layout>
